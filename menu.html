<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRAVIN</title>

  <style>
    /* Paste your original CSS here (unchanged). */
    /* The CSS section from your file remains as is. */
  </style>
</head>

<body onload="loadMenu('KFC'); loadCart();">

  <div class="menu-icon" onclick="toggleMenu()">â˜°</div>

  <div class="cart-icon" onclick="toggleCart()">
    <button style="background: none; border: none; font-size: 24px; cursor: pointer; position: relative;">
      ðŸ›’
      <span id="cart-count" style="position: absolute; top: -5px; right: -10px; background: red; color: white; font-size: 12px; padding: 2px 6px; border-radius: 50%; display: none;">0</span>
    </button>
  </div>

  <div id="cart-dropdown">
    <h3></h3>
    <div id="cart-items">
      <p>Your cart is empty.</p>
    </div>
    <button id="checkout-btn" onclick="openCheckout()" style="display:none;">CHECKOUT</button>
  </div>

  <div class="top-bar"><h1>KRAVIN'</h1></div>

  <div class="dropdown" id="menu-dropdown">
    <div class="user-info">Welcome to KRAVIN'</div>

    <div class="dropdown-title">RESTAURANTS</div>

    <a href="#" onclick="loadMenu('KFC')">KFC</a>
    <a href="#" onclick="loadMenu('LasVagas')">Las Vagas</a>
    <a href="#" onclick="loadMenu('Cloggys')">Cloggys</a>
    <a href="#" onclick="loadMenu('Waterloo')">Waterloo Guesthouse</a>
    <a href="#" onclick="loadMenu('Tasty')">Tasty</a>

    <div style="margin-top: 15px; padding: 10px; border-top: 1px solid #ccc; font-size: 14px; color: #333;">
      <p><span style="font-weight: 700; text-transform: uppercase;">Opening Hours:</span><br>MON-SAT 10:00 AM - 09:00 PM<br>SUNDAY 11:00 AM - 09:00 PM</p>
      <p style="margin-top: 20px;"><span style="font-weight: 700; text-transform: uppercase;">Estimated Delivery Time:</span><br>15-30 Min</p>
    </div>
  </div>

  <div id="product-list">Loading menu...</div>

  <div id="checkout-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeCheckout()">&times;</span>
      <h2>CHECKOUT</h2>

      <form id="checkout-form">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required />

        <label for="phone">Phone Number:</label>
        <input type="tel" id="phone" name="phone" required />
        <p id="error-message" style="color: red;"></p>

        <label for="address">Address:</label>
        <textarea id="address" name="address" required></textarea>

        <p id="delivery-fee">Delivery Fee: JMD $0.00</p>
        <p id="total-price">Total: JMD $0.00</p>

        <button type="button" onclick="payOnArrival()">PAY UPON ARRIVAL</button>

        <p id="form-error" style="color:red; display:none;"></p>
        <p id="payment-success" style="color:green; display:none;">Order received! Thank you.</p>
      </form>
    </div>
  </div>

<script>
const phoneInput = document.getElementById("phone");
const errorMessage = document.getElementById("error-message");

phoneInput.addEventListener("input", () => {
  let digits = phoneInput.value.replace(/\D/g, "").substring(0, 10);
  let formatted = "";

  if (digits.length > 0) formatted += "(" + digits.substring(0, 3);
  if (digits.length >= 4) formatted += ") " + digits.substring(3, 6);
  if (digits.length >= 7) formatted += "-" + digits.substring(6, 10);

  phoneInput.value = formatted;
});

document.getElementById("checkout-form").addEventListener("submit", function (e) {
  const digitsOnly = phoneInput.value.replace(/\D/g, "");
  if (digitsOnly.length !== 10) {
    e.preventDefault();
    errorMessage.textContent = "Phone number must be exactly 10 digits.";
  } else {
    errorMessage.textContent = "";
  }
});

let currentRestaurant = "KFC";
let cart = [];

const sheets = {
  KFC: "133XVcwdZQYVDidJbOflqpE49R2mTsQTwPvhBynCCcQ4",
  LasVagas: "1cQjpoY_Yt4YCdbGGPKf3k3PNUrm7rXHWo4J3MXJnRNE",
  Cloggys: "1Zp2p2d6mD8bGfZoylkJkXSwqboZNq4i-3yP8NRWaqXE",
  Waterloo: "1Ya1yxamB0g2Ov8HSOeTLYd3oKzsPJeLJ0zgrn-y3Lvs",
  Tasty: "16apFsQAAYRIf2EzdiW8M1KX8S4NoZwFoCwRlV1fH7_0"
};

const sheetName = "Sheet1";

function loadMenu(restaurant) {
  currentRestaurant = restaurant;

  const sheetId = sheets[restaurant];
  if (!sheetId) {
    document.getElementById('product-list').innerHTML = 'Menu not available.';
    return;
  }

  const url = `https://opensheet.elk.sh/${sheetId}/${sheetName}`;

  fetch(url)
    .then(response => response.json())
    .then(data => {
      const productList = document.getElementById('product-list');
      productList.innerHTML = '';

      data.forEach(item => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        productDiv.innerHTML = `
          <img src="${item.Image}" alt="${item.Name}">
          <h3>${item.Name}</h3>
          <p>${item.Price}</p>
          <button onclick="addToCart('${item.Name}', '${item.Price}', '${item.Image}')">Add to Cart</button>
        `;
        productList.appendChild(productDiv);
      });
    })
    .catch(error => {
      console.error('Error loading menu:', error);
      document.getElementById('product-list').innerHTML = 'Failed to load menu.';
    });

  document.getElementById("menu-dropdown").style.display = "none";
}

function calculateDeliveryFee() {
  const address = document.getElementById("address").value.trim().toLowerCase();

  if (address.includes("brompton")) return 1500;
  if (address.includes("black river")) return 1000;
  if (address.includes("speculation")) return 1000;
  if (address.includes("luana")) return 1000;
  if (address.includes("crawford")) return 1000;
  if (address.includes("shrewsbury")) return 1000;
  if (address.includes("cambridge")) return 1000;
  if (address.includes("fyffes pen")) return 1000;
  if (address.includes("oxford")) return 1000;
  if (address.includes("lewis town")) return 1000;
  if (address.includes("sandy ground")) return 1800;
  if (address.includes("hodges")) return 1000;

  return 0;
}

function calculateCartTotal() {
  let total = 0;
  cart.forEach(item => {
    const priceNum = parseFloat(item.price.replace(/[^0-9.]/g, ""));
    if (!isNaN(priceNum)) {
      total += priceNum * item.quantity;
    }
  });
  return total;
}

function updateFeesAndTotal() {
  const deliveryFee = calculateDeliveryFee();
  const cartTotal = calculateCartTotal();
  const grandTotal = cartTotal + deliveryFee;

  document.getElementById("delivery-fee").textContent = `Delivery Fee: JMD $${deliveryFee.toFixed(2)}`;
  document.getElementById("total-price").textContent = `Total: JMD $${grandTotal.toFixed(2)}`;
}

document.getElementById("address").addEventListener("input", updateFeesAndTotal);

function addToCart(name, price, image) {
  if (cart.length > 0 && cart[0].restaurant !== currentRestaurant) {
    alert("YOU CAN ONLY ORDER FROM ONE RESTAURANT AT A TIME");
    return;
  }

  const existing = cart.find(i => i.name === name);
  if (existing) {
    existing.quantity += 1;
  } else {
    cart.push({ name, price, image, quantity: 1, restaurant: currentRestaurant });
  }

  updateCartUI();
  saveCart();
  updateFeesAndTotal();
  showAddedToCartPopup();
  document.getElementById("cart-dropdown").style.display = "block";
}

function removeFromCart(name) {
  const index = cart.findIndex(i => i.name === name);
  if (index > -1) {
    cart.splice(index, 1);
    updateCartUI();
    saveCart();
    updateFeesAndTotal();
  }
}

function increaseQuantity(name) {
  const item = cart.find(i => i.name === name);
  if (item) {
    item.quantity += 1;
    updateCartUI();
    saveCart();
    updateFeesAndTotal();
  }
}

function decreaseQuantity(name) {
  const item = cart.find(i => i.name === name);
  if (item) {
    if (item.quantity > 1) {
      item.quantity -= 1;
      updateCartUI();
      saveCart();
      updateFeesAndTotal();
    } else {
      removeFromCart(name);
    }
  }
}

function updateCartUI() {
  const countElem = document.getElementById("cart-count");
  const cartItemsElem = document.getElementById("cart-items");
  const checkoutBtn = document.getElementById("checkout-btn");

  const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
  if (totalQuantity > 0) {
    countElem.style.display = "inline-block";
    countElem.textContent = totalQuantity;
    checkoutBtn.style.display = "block";
  } else {
    countElem.style.display = "none";
    checkoutBtn.style.display = "none";
  }

  if (cart.length === 0) {
    cartItemsElem.innerHTML = "<p>Your cart is empty.</p>";
    return;
  }

  cartItemsElem.innerHTML = "";
  cart.forEach(item => {
    const itemDiv = document.createElement("div");
    itemDiv.innerHTML = `
      <img src="${item.image}" alt="${item.name}" style="width:50px; height:50px; object-fit:cover; margin-right:10px;" />
      <div style="flex-grow:1;">
        <strong>${item.name}</strong><br/>
        ${item.price} x ${item.quantity}
      </div>
      <button onclick="decreaseQuantity('${item.name}'); event.stopPropagation();" style="width:28px; height:28px; font-size:20px; margin-right:5px;">âˆ’</button>
      <button onclick="increaseQuantity('${item.name}'); event.stopPropagation();" style="width:28px; height:28px; font-size:20px; margin-right:10px;">+</button>
      <button class="remove-item" onclick="removeFromCart('${item.name}'); event.stopPropagation();" style="font-size:22px;">&times;</button>
    `;
    cartItemsElem.appendChild(itemDiv);
  });
}

function toggleCart() {
  const dropdown = document.getElementById("cart-dropdown");
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
}

document.addEventListener('click', function (event) {
  const cartDropdown = document.getElementById('cart-dropdown');
  const cartIcon = document.querySelector('.cart-icon');
  if (!cartDropdown.contains(event.target) && !cartIcon.contains(event.target)) {
    cartDropdown.style.display = 'none';
  }
});

function saveCart() {
  localStorage.setItem('kravinCart', JSON.stringify(cart));
}

function loadCart() {
  const savedCart = localStorage.getItem('kravinCart');
  if (savedCart) {
    cart = JSON.parse(savedCart);
    updateCartUI();
    updateFeesAndTotal();
  }
}

function toggleMenu() {
  const dropdown = document.getElementById("menu-dropdown");
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
}

function openCheckout() {
  document.getElementById("form-error").style.display = "none";
  document.getElementById("payment-success").style.display = "none";
  document.getElementById("checkout-form").style.display = "block";
  document.getElementById("checkout-modal").style.display = "flex";
}

function closeCheckout() {
  document.getElementById("checkout-modal").style.display = "none";
  document.getElementById("checkout-form").reset();
}

function showAddedToCartPopup() {
  let popup = document.getElementById("added-popup");
  if (!popup) {
    popup = document.createElement("div");
    popup.id = "added-popup";
    popup.textContent = "ADDED TO CART";
    popup.style.position = "fixed";
    popup.style.bottom = "20px";
    popup.style.right = "20px";
    popup.style.backgroundColor = "#28a745";
    popup.style.color = "#fff";
    popup.style.padding = "12px 20px";
    popup.style.borderRadius = "8px";
    popup.style.fontWeight = "bold";
    popup.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
    popup.style.zIndex = "9999";
    document.body.appendChild(popup);
  }

  popup.style.opacity = "1";

  setTimeout(() => {
    popup.style.transition = "opacity 0.5s";
    popup.style.opacity = "0";
  }, 1500);
}

async function payOnArrival() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();

  if (name === "" || phone === "" || address === "") {
    document.getElementById("form-error").textContent = "Please fill out all fields.";
    document.getElementById("form-error").style.display = "block";
    return;
  }

  document.getElementById("form-error").style.display = "none";

  let orderDetails = `Order for ${name}\nPhone: ${phone}\nAddress: ${address}\n\nItems:\n`;
  cart.forEach(item => {
    orderDetails += `${item.name} - ${item.price} x ${item.quantity}\n`;
  });
  orderDetails += `\nTotal: ${document.getElementById("total-price").textContent}`;

  alert("Order Received:\n" + orderDetails);

  document.getElementById("payment-success").style.display = "block";

  cart = [];
  saveCart();
  updateCartUI();
  updateFeesAndTotal();

  setTimeout(() => {
    closeCheckout();
  }, 2000);
}
</script>

</body>
</html>
