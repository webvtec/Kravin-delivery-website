<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRAVIN DELIVERY</title>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=JMD" data-sdk-integration-source="button-factory"></script>

  <style>
    /* Your existing styles here... */

    /* Cart styles */
    #cart-modal {
      position: fixed;
      top: 60px;
      right: 10px;
      width: 320px;
      max-height: 400px;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
      padding: 10px;
      display: none;
      flex-direction: column;
      z-index: 1002;
      overflow-y: auto;
    }
    #cart-items {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }
    .cart-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 8px;
    }
    .cart-item-info {
      flex-grow: 1;
    }
    .cart-item-controls button {
      margin-left: 6px;
    }
    #cart-count {
      font-weight: bold;
      color: white;
      background: red;
      border-radius: 50%;
      padding: 2px 7px;
      font-size: 14px;
      position: absolute;
      top: 0;
      right: 0;
    }
  </style>
</head>
<body>

  <!-- Menu Icon -->
  <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>

  <!-- Cart Icon -->
  <div class="cart-icon" style="position:relative;">
    <button onclick="toggleCart()" style="background:none; border:none; font-size:24px; cursor:pointer;">üõí</button>
    <span id="cart-count" style="display:none;">0</span>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal">
    <h3>Your Cart</h3>
    <div id="cart-items">Cart is empty.</div>
    <div id="paypal-button-container"></div>
  </div>

  <!-- Top Bar -->
  <div class="top-bar"><h1>KRAVIN DELIVERY</h1></div>

  <!-- Dropdown Menu -->
  <div class="dropdown" id="menu-dropdown">
    <!-- User profile and restaurant links as before -->
  </div>

  <!-- Product Grid -->
  <div id="product-list">Loading menu...</div>

<script>
  // Your Firebase and other code remains unchanged here

  // Simple cart array to hold items
  let cart = [];

  // Add item to cart
  function addToCart(item) {
    const existing = cart.find(i => i.id === item.id);
    if (existing) {
      existing.quantity++;
    } else {
      cart.push({...item, quantity: 1});
    }
    updateCartCount();
    alert(`${item.name} added to cart.`);
  }

  // Remove item from cart
  function removeFromCart(id) {
    cart = cart.filter(i => i.id !== id);
    updateCartCount();
    renderCart();
  }

  // Change quantity
  function changeQuantity(id, delta) {
    const item = cart.find(i => i.id === id);
    if (!item) return;
    item.quantity += delta;
    if (item.quantity <= 0) {
      removeFromCart(id);
    } else {
      renderCart();
      updateCartCount();
    }
  }

  // Update cart count display
  function updateCartCount() {
    const count = cart.reduce((sum, i) => sum + i.quantity, 0);
    const cartCount = document.getElementById('cart-count');
    if (count > 0) {
      cartCount.style.display = 'inline-block';
      cartCount.textContent = count;
    } else {
      cartCount.style.display = 'none';
    }
  }

  // Render cart modal content
  function renderCart() {
    const container = document.getElementById('cart-items');
    if (cart.length === 0) {
      container.innerHTML = 'Cart is empty.';
      document.getElementById('paypal-button-container').innerHTML = '';
      return;
    }

    container.innerHTML = '';
    cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <img src="${item.image}" alt="${item.name}" />
        <div class="cart-item-info">
          <strong>${item.name}</strong><br />
          JMD ${item.price} x ${item.quantity} = JMD ${(item.price * item.quantity).toFixed(2)}
        </div>
        <div class="cart-item-controls">
          <button onclick="changeQuantity('${item.id}', 1)">+</button>
          <button onclick="changeQuantity('${item.id}', -1)">-</button>
          <button onclick="removeFromCart('${item.id}')">x</button>
        </div>
      `;
      container.appendChild(div);
    });

    renderPayPalButtons();
  }

  // Toggle cart modal visibility
  function toggleCart() {
    const modal = document.getElementById('cart-modal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    if (modal.style.display === 'flex') {
      renderCart();
    }
  }

  // Load menu and add event listeners for add-to-cart buttons
  function loadMenu(restaurant) {
    const sheetId = sheets[restaurant];
    const sheetUrl = `https://opensheet.elk.sh/${sheetId}/${sheetName}`;
    const container = document.getElementById("product-list");
    container.innerHTML = "Loading menu...";

    fetch(sheetUrl)
      .then(res => res.json())
      .then(data => {
        container.innerHTML = "";
        data.forEach(item => {
          const product = document.createElement("div");
          product.className = "product";
          product.innerHTML = `
            <img src="${item.Image}" alt="${item.Name}" />
            <h3>${item.Name}</h3>
            <p><strong>JMD ${item.Price}</strong></p>
            <button style="background-color:#ff6600; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">
              Add to Cart
            </button>
          `;
          // Add event listener to add item to cart
          product.querySelector("button").addEventListener("click", () => {
            addToCart({
              id: item.Name.replace(/\s+/g, '-').toLowerCase(),
              name: item.Name,
              price: parseFloat(item.Price.replace(/[^0-9.]/g, '')) || 0,
              image: item.Image
            });
          });
          container.appendChild(product);
        });
      })
      .catch(() => {
        container.innerHTML = `<p style="color:red; text-align:center;">‚ùå Failed to load menu for ${restaurant}.</p>`;
      });

    document.getElementById("menu-dropdown").style.display = "none";
  }

  // PayPal Buttons render & create order
  function renderPayPalButtons() {
    const container = document.getElementById('paypal-button-container');
    container.innerHTML = ''; // clear previous buttons

    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    if (total <= 0) return;

    paypal.Buttons({
      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              currency_code: "JMD",
              value: total.toFixed(2)
            },
            description: "KRAVIN DELIVERY Order"
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          alert(`Transaction completed by ${details.payer.name.given_name}!`);
          // Optionally, clear cart or redirect to a thank-you page
          cart = [];
          updateCartCount();
          renderCart();
        });
      },
      onError: function(err) {
        alert('Payment error: ' + err);
      }
    }).render('#paypal-button-container');
  }

  // Load default menu on page load
  window.onload = () => {
    loadMenu("KFC");
  };

</script>

</body>
</html>
